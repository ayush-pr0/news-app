services:
  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    ports:
      - 9090:9090
    environment:
      - SERVER_HOST=${SERVER_HOST:-host.docker.internal}
      - SERVER_PORT=${SERVER_PORT:-8000}
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml.tmpl:ro
    entrypoint: ["/bin/sh","-c"]
    command:
      - >
        set -e;
        echo "SERVER_HOST=$${SERVER_HOST} SERVER_PORT=$${SERVER_PORT}";
        TARGET="$${SERVER_HOST}:$${SERVER_PORT}";
        echo "Resolved TARGET=$${TARGET}";
        sed "s|__APP_TARGET__|$${TARGET}|g" /etc/prometheus/prometheus.yml.tmpl > /etc/prometheus/prometheus.yml;
        echo "--- Rendered /etc/prometheus/prometheus.yml ---";
        cat /etc/prometheus/prometheus.yml;
        /bin/prometheus --config.file=/etc/prometheus/prometheus.yml

  grafana:
    image: grafana/grafana-oss:latest
    container_name: grafana
    ports:
      - 3000:3000
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
    volumes:
      - grafana-storage:/var/lib/grafana

volumes:
  grafana-storage: